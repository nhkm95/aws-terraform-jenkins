pipeline {
  agent any

  options {
    timestamps()
    disableConcurrentBuilds()
  }

  environment {
    TF_IN_AUTOMATION   = 'true'
    TF_INPUT           = 'false'
    TF_CLI_ARGS        = '-no-color'
    AWS_DEFAULT_REGION = 'ap-southeast-1'

    PLAN_OUT_PATH  = 'tfplan.bin'
    PLAN_JSON_PATH = 'tfplan.json'

    // S3 backend & plan bucket names come from Jenkins credentials (Secret Text)
    S3_STATE_BUCKET = credentials('tf_state_bucket')
    S3_STATE_KEY    = credentials('tf_state_key')
    S3_PLAN_BUCKET  = credentials('tf_plan_bucket')
    S3_PLAN_PREFIX  = 'plans/dev'
  }

  stages {
    stage('Checkout') {
      steps {
        git url: 'https://github.com/nhkm95/aws-terraform-jenkins.git', branch: 'main'
      }
    }

    stage('Terraform init') {
      steps {
        dir('env/dev') {           // <<< FIXED: env/dev not envs/dev
          sh '''cat > backend.hcl <<EOF
bucket  = "${S3_STATE_BUCKET}"
key     = "${S3_STATE_KEY}"
region  = "${AWS_DEFAULT_REGION}"
encrypt = true
EOF

terraform init -backend-config=backend.hcl
'''
        }
      }
    }

    stage('Terraform fmt & validate') {
      steps {
        dir('env/dev') {          // <<< FIXED
          // fmt prints changed files and exits 3 if changes needed, so don't fail the build on that
          sh 'terraform fmt -check || true'
          sh 'terraform validate'
        }
      }
    }

    stage('Plan') {
      steps {
        dir('env/dev') {          // <<< FIXED
          // dev.tfvars as Secret File
          withCredentials([file(credentialsId: 'dev_tfvars_file', variable: 'DEV_TFVARS_PATH')]) {
            sh '''
set -e

echo "Working dir: $(pwd)"
echo "Files:"
ls -la

cp "$DEV_TFVARS_PATH" dev.tfvars

terraform plan -out=${PLAN_OUT_PATH} -var-file=dev.tfvars
terraform show -json ${PLAN_OUT_PATH} > ${PLAN_JSON_PATH}

aws s3 cp ${PLAN_OUT_PATH} s3://${S3_PLAN_BUCKET}/${S3_PLAN_PREFIX}/${BUILD_NUMBER}.tfplan
aws s3 cp ${PLAN_JSON_PATH} s3://${S3_PLAN_BUCKET}/${S3_PLAN_PREFIX}/${BUILD_NUMBER}.json
'''
          }

          archiveArtifacts artifacts: "tfplan.bin, tfplan.json", fingerprint: true
        }
      }
    }

    stage('Approve Apply') {
      steps {
        input message: 'Apply this Terraform plan to dev?', ok: 'Apply'
      }
    }

    stage('Apply') {
      steps {
        dir('env/dev') {          // <<< FIXED
          sh 'terraform apply -auto-approve $PLAN_OUT_PATH'
        }
      }
    }
  }

  post {
    always {
      dir('env/dev') {           // <<< FIXED
        sh 'rm -f tfplan.bin tfplan.json backend.hcl dev.tfvars || true'
      }
    }
  }
}
