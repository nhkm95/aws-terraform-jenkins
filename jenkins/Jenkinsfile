pipeline {
  agent any

  options {
    timestamps()
    disableConcurrentBuilds()
  }

  environment {
    TF_IN_AUTOMATION   = 'true'
    TF_INPUT           = 'false'
    TF_CLI_ARGS        = '-no-color'
    AWS_DEFAULT_REGION = 'ap-southeast-1'

    PLAN_OUT_PATH  = 'tfplan.bin'
    PLAN_JSON_PATH = 'tfplan.json'

    // S3 backend & plan bucket names come from Jenkins credentials (secret text)
    S3_STATE_BUCKET = credentials('tf_state_bucket')
    S3_STATE_KEY    = credentials('tf_state_key')
    S3_PLAN_BUCKET  = credentials('tf_plan_bucket')
    S3_PLAN_PREFIX  = 'plans/dev'
  }

  stages {
    stage('Checkout') {
      steps {
        // For a simple Pipeline job, use explicit git step
        git url: 'https://github.com/nhkm95/aws-terraform-jenkins.git', branch: 'main'
      }
    }

    stage('Terraform init') {
      steps {
        dir('envs/dev') {
          // Write backend.hcl using heredoc
          sh '''cat > backend.hcl <<EOF
bucket = "${S3_STATE_BUCKET}"
key    = "${S3_STATE_KEY}"
region = "${AWS_DEFAULT_REGION}"
encrypt = true
EOF
terraform init -backend-config=backend.hcl
'''
        }
      }
    }

    stage('Terraform fmt & validate') {
      steps {
        dir('envs/dev') {
          sh 'terraform fmt -check'
          sh 'terraform validate'
        }
      }
    }

    stage('Plan') {
      steps {
        dir('envs/dev') {
          // Inject dev.tfvars from Jenkins credentials
          withCredentials([string(credentialsId: 'dev_tfvars', variable: 'DEV_TFVARS_CONTENT')]) {
            writeFile file: 'dev.tfvars', text: "${DEV_TFVARS_CONTENT}"
          }

          sh 'terraform plan -out=$PLAN_OUT_PATH -var-file=dev.tfvars'
          sh 'terraform show -json $PLAN_OUT_PATH > $PLAN_JSON_PATH'

          // Upload plan artifacts to S3
          sh 'aws s3 cp $PLAN_OUT_PATH s3://$S3_PLAN_BUCKET/$S3_PLAN_PREFIX/${BUILD_NUMBER}.tfplan'
          sh 'aws s3 cp $PLAN_JSON_PATH s3://$S3_PLAN_BUCKET/$S3_PLAN_PREFIX/${BUILD_NUMBER}.json'

          archiveArtifacts artifacts: "tfplan.bin, tfplan.json", fingerprint: true
        }
      }
    }

    stage('Approve Apply') {
      steps {
        input message: 'Apply this Terraform plan to dev?', ok: 'Apply'
      }
    }

    stage('Apply') {
      steps {
        dir('envs/dev') {
          // dev.tfvars is already present from Plan stage; if you want to be
          // extra-safe, you can re-write it from credentials again.
          sh 'terraform apply -auto-approve $PLAN_OUT_PATH'
        }
      }
    }
  }

  post {
    always {
      dir('envs/dev') {
        sh 'rm -f tfplan.bin tfplan.json backend.hcl dev.tfvars || true'
      }
    }
  }
}
