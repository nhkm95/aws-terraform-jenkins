#cloud-config
package_update: true
package_upgrade: false
packages:
  - git
  - unzip
  - curl
  - openjdk-17-jre

runcmd:
  # Install Terraform
  - curl -fsSL https://apt.releases.hashicorp.com/gpg | gpg --dearmor -o /usr/share/keyrings/hashicorp-archive-keyring.gpg
  - echo "deb [signed-by=/usr/share/keyrings/hashicorp-archive-keyring.gpg] https://apt.releases.hashicorp.com $(. /etc/os-release && echo $VERSION_CODENAME) main" | tee /etc/apt/sources.list.d/hashicorp.list
  - apt-get update && apt-get install -y terraform

  # Install Jenkins
  - curl -fsSL https://pkg.jenkins.io/debian-stable/jenkins.io-2023.key | tee /usr/share/keyrings/jenkins-keyring.asc > /dev/null
  - echo "deb [signed-by=/usr/share/keyrings/jenkins-keyring.asc] https://pkg.jenkins.io/debian-stable binary/" | tee /etc/apt/sources.list.d/jenkins.list > /dev/null
  - apt-get update && apt-get install -y jenkins

  # Core plugins needed for Terraform pipelines
  - su -s /bin/bash jenkins -c 'mkdir -p /var/lib/jenkins/plugins'
  - su -s /bin/bash jenkins -c 'echo -e "workflow-aggregator\ngit\ncredentials\ncredentials-binding\ntimestamper\n" > /var/lib/jenkins/plugins.txt'
  - jenkins-plugin-cli --plugin-file /var/lib/jenkins/plugins.txt || true

  - systemctl enable --now jenkins

  - "sleep 10 && echo 'JENKINS INITIAL PASSWORD:' && cat /var/lib/jenkins/secrets/initialAdminPassword || true"

final_message: "Jenkins setup complete. Visit http://<public-dns>:8080"
